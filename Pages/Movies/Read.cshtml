@page "{id:int?}"
@model ReadModel
@using Microsoft.AspNetCore.Mvc.RazorPages;
@using DotNetRazorPages.Entity;
@using Models;
@using Paging;

@{
    ViewData["Title"] = "Movies";
}

<style>
    .pagingDiv {
        background: #f2f2f2;
    }

    .pagingDiv>a {
        display: inline-block;
        padding: 0px 9px;
        margin-right: 4px;
        border-radius: 3px;
        border: solid 1px #c0c0c0;
        background: #e9e9e9;
        box-shadow: inset 0px 1px 0px rgba(255, 255, 255, .8), 0px 1px 3px rgba(0, 0, 0, .1);
        font-size: .875em;
        font-weight: bold;
        text-decoration: none;
        color: #717171;
        text-shadow: 0px 1px 0px rgba(255, 255, 255, 1);
    }

    .pagingDiv>a:hover {
        background: #fefefe;
        background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#FEFEFE), to(#f0f0f0));
        background: -moz-linear-gradient(0% 0% 270deg, #FEFEFE, #f0f0f0);
    }

    using Microsoft.EntityFrameworkCore.Design;

    .pagingDiv>a.active {
        border: none;
        background: #616161;
        box-shadow: inset 0px 0px 8px rgba(0, 0, 0, .5), 0px 1px 0px rgba(255, 255, 255, .8);
        color: #f0f0f0;
        text-shadow: 0px 0px 3px rgba(0, 0, 0, .5);
    }
</style>

<h1 class="bg-info text-white">Movies</h1>
<a asp-page="Create" class="btn btn-secondary">Create a Movie</a>

<table class="table table-sm table-bordered">
    <tr>
        <th>Id</th>
        <th>Name</th>
        <th>Actors</th>
        <th></th>
        <th></th>
    </tr>
    @foreach (Movie m in Model.movieList!.Movies)
    {
        <tr>
            <td>@m.Id</td>
            <td>@m.Name</td>
            <td>@m.Actors</td>
            <td>
                <a class="btn btn-sm btn-primary" asp-page="Update" asp-route-id="@m.Id">
                    Update
                </a>
            </td>
            <td>
                <form asp-page-handler="Delete" asp-route-id="@m.Id" method="post">
                    <button type="submit" class="btn btn-sm btn-danger">
                        Delete
                    </button>
                </form>
            </td>
        </tr>
    }
</table>

<div class="pagingDiv" page-model="Model.movieList.PagingInfo" page-name="Read" page-classes-enabled="true"
    page-class="paging" page-class-selected="active"></div>


@functions {
    public class ReadModel : PageModel
    {
        private readonly IRepository<Movie> _repository;
        public ReadModel(IRepository<Movie> repository)
        {
            _repository = repository;
        }

        public MovieList? movieList { get; set; }

        public async Task OnGet(int id)
        {
            PagingInfo pagingInfo = new PagingInfo();
            movieList = new MovieList()
            {
                Movies = new List<Movie>(),
                PagingInfo = pagingInfo
            };

            int pageSize = 1;
            pagingInfo.CurrentPage = id == 0 ? 1 : id;
            pagingInfo.ItemsPerPage = pageSize;

            var skip = pageSize * (Convert.ToInt32(id) - 1);
            var resultTuple = await _repository.ReadAllFilterAsync(skip, pageSize);

            pagingInfo.TotalItems = resultTuple.Item2;
            movieList.Movies = resultTuple.Item1;
            movieList.PagingInfo = pagingInfo;
        }

        public async Task<IActionResult> OnPostDeleteAsync(int id)
        {
            await _repository.DeleteAsync(id);
            return RedirectToPage("Read", new { id = 1 });
        }
    }
}